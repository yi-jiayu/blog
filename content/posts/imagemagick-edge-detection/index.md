---
title: "Edge detection with ImageMagick"
subtitle: "An attempt at generating line art from Pokémon images"
date: 2019-05-14 22:43:44+08:00
---

Recently, I was trying to generate line art from Ken Sugimori Pokémon artwork, like this Turtwig
here:

{{< figure src="turtwig.png" alt="Drawing of the Pokémon Turtwig by Ken Sugimori" >}}

I came across [this site][7] which did a pretty good job out of the box, with some more options for
customisation:

{{< figure src="turtwig-outline.png" alt="Line art of the Turtwig drawing generated by the website" >}}

Could we do something similar be done with ImageMagick?

## Preprocessing

To make things easier for our edge detection algorithms, let's preprocess our image by converting it
to grayscale and remove the alpha channel.

The following command does this and saves the output to the non-portable ImageMagick-specific Magick
Persistent Cache intermediate format (search for "MPC" at [Supported image formats][8]):

```
convert turtwig.png -colorspace gray -alpha remove turtwig-preprocessed.mpc
```
This will create two files, `turtwig-preprocessed.mpc` and `turtwig-preprocessed.cache`.

Without removing the alpha channel, it seems that most edge detection techniques (which mainly look
for sudden changes in colour) only return Turtwig's outline, presumably because the alpha
values suddenly go from 0% in the background to 100% on Turtwig:

{{< figure src="turtwig-border.png" alt="An outline of the Turtwig drawing caused by trying to run edge detection with the alpha channel" >}}

## Convolution

Before deep learning and convolutional networks became mainstream, a similar technique with [image
kernels][1] was already in use for image processing. Effects such as blurring, sharpening and
embossing---which some may have first encountered in image editing software---are applied by
performing a convolution with an appropriate kernel.

Edge detection is just another effect, and there are specific kernels which can be used to do this,
for example the [Sobel operator][2] and [Roberts cross][3], as well as algorithms involving kernels
such as the [Difference of Gaussians][6].

ImageMagick supports convolution and the ImageMagick usage examples contain a section on [Edge
Detection Convolutions][4], which the following snippets are based on.

### Difference of Gaussians

```
convert turtwig-preprocessed.mpc \
	-morphology Convolve DoG:1,0,1 \
	-negate \
	-tint 0 \
	turtwig_laplacian_isotropic.png
```

{{< figure src="turtwig_laplacian_isotropic.png" alt="Edges in the Turtwig drawing as detected using Difference of Gaussians" >}}

### Discrete Laplacian kernels

```
convert turtwig-preprocessed.mpc \
	-define convolve:scale='!' \
	-morphology Convolve Laplacian:0 \
	-negate \
	-tint 0 \
	turtwig_laplacian_0.png
```

{{< figure src="turtwig_laplacian_0.png" alt="Edges in the Turtwig drawing as detected with discrete Laplacian kernels" >}}

### Sobel operator

```
convert turtwig-preprocessed.mpc \
	-define convolve:scale='50%!' \
	-bias 50% \
	\( -clone 0 -morphology Convolve Sobel:0 \) \
	\( -clone 0 -morphology Convolve Sobel:90 \) \
	-delete 0 \
	-solarize 50% \
	-level 50,0% \
	-compose Lighten \
	-composite \
	-negate \
	turtwig_sobel_maximum_3.png
```

{{< figure src="turtwig_sobel_maximum_3.png" alt="Edges in the Turtwig drawing as detected using the Sobel operator" >}}

### Roberts cross

```
convert turtwig-preprocessed.mpc \
	-define morphology:compose=Lighten \
	-morphology Convolve 'Roberts:@' \
	-negate \
	turtwig_roberts_maximum.png
```

{{< figure src="turtwig_roberts_maximum.png" alt="Edges in the Turtwig drawing as detected using the Roberts cross" >}}

Combining the Roberts cross with a [Gaussian blur][13] and the [`-auto-threshold`][12] option seems to provide the best
results:

```
convert turtwig-preprocessed.mpc \
	-define morphology:compose=Lighten \
	-morphology Convolve 'Roberts:@' \
	-negate \
	-gaussian-blur 1x1 \
	-auto-threshold OTSU \
	turtwig_roberts_maximum_threshold.png
```

{{< figure src="turtwig_roberts_maximum_threshold.png" alt="Edges in the Turtwig drawing as detected with the Roberts cross and post-processed with a Gaussian blur and auto thresholding" >}}

## Computer vision transformations

Turns out that as an alternative to fiddling with image kernels, ImageMagick also provides some built-in line detection algorithms as well. These are shown under [Computer Vision
Transformations][10].

### Edge detection

```
convert turtwig-preprocessed.mpc -negate -edge 1 -negate turtwig-edge.png
```

{{< figure src="turtwig-edge.png" alt="Edges in the Turtwig drawing as detected by the edge detection option" >}}

The double negation avoids "twinning" in the detected edges.

### Canny edge detector

The [Canny edge detector][11] is an advanced, multi-stage algorithm for edge detection.

```
convert turtwig-preprocessed.mpc -canny 0x1+10%+30% -negate turtwig-canny.png
```

{{< figure src="turtwig-canny.png" alt="Edges in the Turtwig drawing as detected with the Canny edge detector" >}}

## Bonus: Colour masking

It just happens that Sugimori Pokémon images already happen to have nice black lines already. What
if we just removed every pixel which wasn't black ([source][9])?

```
convert turtwig.png \
	-matte \( +clone  -fuzz 15% -transparent black  \) \
	-compose DstOut \
	-composite \
	turtwig_lines.png
```

{{< figure src="turtwig_lines.png" alt="The black lines in the Turtwig drawing with other colours removed" >}}

I guess it kind of works?

[1]: https://en.wikipedia.org/wiki/Kernel_(image_processing)
[2]: https://en.wikipedia.org/wiki/Prewitt_operator
[3]: https://en.wikipedia.org/wiki/Prewitt_operator
[4]: https://www.imagemagick.org/Usage/convolve/#edgedet
[5]: http://setosa.io/ev/image-kernels/
[6]: https://en.wikipedia.org/wiki/Difference_of_Gaussians
[7]: https://online.rapidresizer.com/photograph-to-pattern.php
[8]: https://imagemagick.org/script/formats.php#supported
[9]: https://www.imagemagick.org/discourse-server/viewtopic.php?p=21394&sid=9f9cfdd518e0434e9c1541c4bb8d2403#p21394
[10]: https://www.imagemagick.org/Usage/transform/#vision
[11]: https://en.wikipedia.org/wiki/Canny_edge_detector
[12]: https://imagemagick.org/script/command-line-options.php#auto-threshold
[13]: https://www.imagemagick.org/script/command-line-options.php?#gaussian-blur
